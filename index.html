<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Comparador de Cargas de Granos</title>
<style>
body { font-family: Arial; margin:20px; background:#f8f8f8; }
h1, h2, h3 { margin:5px 0; }
button { margin:3px; padding:5px 10px; cursor:pointer; }
table { border-collapse: collapse; width: 100%; margin-top:10px; background:#fff; }
th, td { border: 1px solid #ccc; padding: 5px; text-align:center; }
.result { font-weight:bold; color:green; }
#editor, #relatorio { border:1px solid #ccc; padding:10px; margin-top:20px; background:#fff; }
.borrador { background:#fff3cd; }
.aplicado { background:#d4edda; }
.descAlto { color:red; font-weight:bold; }
</style>
</head>
<body>

<h1>Comparador de Cargas de Granos</h1>

<button onclick="nuevo()">Nuevo</button>
<button onclick="verRelatorio()">Ver Relatorio Diario</button>

<h2>Lista de Cargas</h2>
<table id="tablaCargas">
<tr>
<th>ID</th><th>Camión</th><th>Chofer</th><th>Entidad</th><th>Peso Salida</th><th>Peso Llegada</th><th>Estado</th><th>Acciones</th>
</tr>
</table>

<div id="editor" style="display:none;">
<h2>Editar Carga</h2>

Camión: <input id="camion" type="text"><br>
Chofer: <input id="chofer" type="text"><br>
Entidad: <input id="entidad" type="text"><br>

<h3>Datos de salida</h3>
Peso (kg): <input id="pesoSalida" type="number"><br>
Humedad (%): <input id="humSalida" type="number"><br>
Impureza (%): <input id="impSalida" type="number"><br>
Calidad (%): <input id="calSalida" type="number"><br>

<h3>Datos de llegada</h3>
Peso (kg): <input id="pesoLlegada" type="number" oninput="calcular()"><br>
Humedad (%): <input id="humLlegada" type="number" oninput="calcular()"><br>
Impureza (%): <input id="impLlegada" type="number" oninput="calcular()"><br>
Calidad (%): <input id="calLlegada" type="number" oninput="calcular()"><br>

<h3>Descuentos manuales (%)</h3>
Humedad: <input id="descHum" type="number" value="0" oninput="calcular()"><br>
Impureza: <input id="descImp" type="number" value="0" oninput="calcular()"><br>
Calidad: <input id="descCal" type="number" value="0" oninput="calcular()"><br>

<h3>Resultados automáticos</h3>
Diferencia de peso: <span id="difPeso" class="result">0</span><br>
Kg Desc Hum: <span id="kgHum" class="result">0</span><br>
Kg Desc Imp: <span id="kgImp" class="result">0</span><br>
Kg Desc Cal: <span id="kgCal" class="result">0</span><br>
Total Descuento: <span id="totalDesc" class="result">0</span><br>

<button onclick="guardar()">Guardar</button>
<button onclick="cerrarEditor()">Cancelar</button>
</div>

<div id="relatorio" style="display:none;">
<h2>Relatorio Diario</h2>

<h3>Filtros</h3>
Fecha: <input type="date" id="filtroFecha">
Entidad: <input type="text" id="filtroEntidad" placeholder="Nombre de la entidad">
<button onclick="verRelatorio()">Aplicar filtro</button>
<button onclick="imprimirRelatorio()">Imprimir Relatorio</button>
<button onclick="cerrarRelatorio()">Cerrar</button>

<div id="resumen"></div>
<table id="tablaRelatorio"></table>
</div>

<script>
let cargas = JSON.parse(localStorage.getItem('cargas')) || [];
let editId = null;

// Mostrar lista de cargas
function mostrarTabla() {
    const tabla = document.getElementById('tablaCargas');
    tabla.innerHTML = `<tr>
<th>ID</th><th>Camión</th><th>Chofer</th><th>Entidad</th><th>Peso Salida</th><th>Peso Llegada</th><th>Estado</th><th>Acciones</th>
</tr>`;
    cargas.forEach(c => {
        let claseEstado = c.estado === "Aplicado"? "aplicado":"borrador";
        tabla.innerHTML += `<tr class="${claseEstado}">
<td>${c.id}</td>
<td>${c.camion}</td>
<td>${c.chofer}</td>
<td>${c.entidad||''}</td>
<td>${c.peso_salida}</td>
<td>${c.peso_llegada}</td>
<td>${c.estado}</td>
<td>
<button onclick="editar(${c.id})">Editar</button>
<button onclick="aplicar(${c.id})">Aplicar</button>
<button onclick="desaplicar(${c.id})">Desaplicar</button>
<button onclick="eliminar(${c.id})">Eliminar</button>
</td>
</tr>`;
    });
}

// Botones principales
function nuevo() {
    editId = null;
    document.getElementById('editor').style.display = 'block';
    document.getElementById('camion').value = '';
    document.getElementById('chofer').value = '';
    document.getElementById('entidad').value = '';
    document.getElementById('pesoSalida').value = '';
    document.getElementById('humSalida').value = '';
    document.getElementById('impSalida').value = '';
    document.getElementById('calSalida').value = '';
    document.getElementById('pesoLlegada').value = '';
    document.getElementById('humLlegada').value = '';
    document.getElementById('impLlegada').value = '';
    document.getElementById('calLlegada').value = '';
    document.getElementById('descHum').value = 0;
    document.getElementById('descImp').value = 0;
    document.getElementById('descCal').value = 0;
    calcular();
}

function editar(id) {
    const c = cargas.find(x => x.id === id);
    editId = id;
    document.getElementById('editor').style.display = 'block';
    document.getElementById('camion').value = c.camion;
    document.getElementById('chofer').value = c.chofer;
    document.getElementById('entidad').value = c.entidad||'';
    document.getElementById('pesoSalida').value = c.peso_salida;
    document.getElementById('humSalida').value = c.humedad_salida;
    document.getElementById('impSalida').value = c.impureza_salida;
    document.getElementById('calSalida').value = c.calidad_salida;
    document.getElementById('pesoLlegada').value = c.peso_llegada;
    document.getElementById('humLlegada').value = c.humedad_llegada;
    document.getElementById('impLlegada').value = c.impureza_llegada;
    document.getElementById('calLlegada').value = c.calidad_llegada;
    document.getElementById('descHum').value = c.desc_humedad;
    document.getElementById('descImp').value = c.desc_impureza;
    document.getElementById('descCal').value = c.desc_calidad;
    calcular();
}

function aplicar(id) {
    const c = cargas.find(x => x.id === id);
    c.estado = "Aplicado";
    localStorage.setItem('cargas', JSON.stringify(cargas));
    mostrarTabla();
}

function desaplicar(id) {
    const c = cargas.find(x => x.id === id);
    c.estado = "Borrador";
    localStorage.setItem('cargas', JSON.stringify(cargas));
    mostrarTabla();
}

function eliminar(id) {
    cargas = cargas.filter(x => x.id !== id);
    localStorage.setItem('cargas', JSON.stringify(cargas));
    mostrarTabla();
}

function cerrarEditor() { document.getElementById('editor').style.display = 'none'; }

// Cálculos automáticos
function calcular() {
    const pesoSalida = parseFloat(document.getElementById('pesoSalida').value) || 0;
    const pesoLlegada = parseFloat(document.getElementById('pesoLlegada').value) || 0;
    const descHum = parseFloat(document.getElementById('descHum').value) || 0;
    const descImp = parseFloat(document.getElementById('descImp').value) || 0;
    const descCal = parseFloat(document.getElementById('descCal').value) || 0;

    document.getElementById('difPeso').innerText = (pesoSalida - pesoLlegada).toFixed(2);
    document.getElementById('kgHum').innerText = (pesoLlegada * descHum /100).toFixed(2);
    document.getElementById('kgImp').innerText = (pesoLlegada * descImp /100).toFixed(2);
    document.getElementById('kgCal').innerText = (pesoLlegada * descCal /100).toFixed(2);
    document.getElementById('totalDesc').innerText = (pesoLlegada*(descHum+descImp+descCal)/100).toFixed(2);
}

// Guardar o actualizar carga
function guardar() {
    const fecha = new Date().toISOString().slice(0,10);
    const data = {
        id: editId || (cargas.length +1),
        fecha: fecha,
        camion: document.getElementById('camion').value,
        chofer: document.getElementById('chofer').value,
        entidad: document.getElementById('entidad').value,
        peso_salida: parseFloat(document.getElementById('pesoSalida').value)||0,
        humedad_salida: parseFloat(document.getElementById('humSalida').value)||0,
        impureza_salida: parseFloat(document.getElementById('impSalida').value)||0,
        calidad_salida: parseFloat(document.getElementById('calSalida').value)||0,
        peso_llegada: parseFloat(document.getElementById('pesoLlegada').value)||0,
        humedad_llegada: parseFloat(document.getElementById('humLlegada').value)||0,
        impureza_llegada: parseFloat(document.getElementById('impLlegada').value)||0,
        calidad_llegada: parseFloat(document.getElementById('calLlegada').value)||0,
        desc_humedad: parseFloat(document.getElementById('descHum').value)||0,
        desc_impureza: parseFloat(document.getElementById('descImp').value)||0,
        desc_calidad: parseFloat(document.getElementById('descCal').value)||0,
        estado: "Borrador"
    };
    if(editId){
        const index = cargas.findIndex(x=>x.id===editId);
        cargas[index] = data;
    } else {
        cargas.push(data);
    }
    localStorage.setItem('cargas', JSON.stringify(cargas));
    cerrarEditor();
    mostrarTabla();
}

// Relatorio con filtros
function verRelatorio() {
    document.getElementById('relatorio').style.display = 'block';
    let totalPeso = 0, sumHum=0, sumImp=0, sumCal=0;

    const filtroFecha = document.getElementById('filtroFecha').value;
    const filtroEntidad = document.getElementById('filtroEntidad').value.toLowerCase();

    let tabla = `<tr>
<th>ID</th><th>Camión</th><th>Chofer</th><th>Entidad</th>
<th>Peso Salida</th><th>Peso Llegada</th><th>Dif Peso</th>
<th>Humedad Salida</th><th>Humedad Llegada</th><th>Kg Desc Hum</th>
<th>Impureza Salida</th><th>Impureza Llegada</th><th>Kg Desc Imp</th>
<th>Calidad Salida</th><th>Calidad Llegada</th><th>Kg Desc Cal</th>
<th>Total Desc</th><th>Estado</th>
</tr>`;

    const cargasFiltradas = cargas.filter(c => {
        const coincideFecha = filtroFecha ? c.fecha === filtroFecha : true;
        const coincideEntidad = filtroEntidad ? c.entidad?.toLowerCase().includes(filtroEntidad) : true;
        return coincideFecha && coincideEntidad;
    });

    cargasFiltradas.forEach(c=>{
        const difPeso = c.peso_salida - c.peso_llegada;
        const kgHum = c.peso_llegada * c.desc_humedad/100;
        const kgImp = c.peso_llegada * c.desc_impureza/100;
        const kgCal = c.peso_llegada * c.desc_calidad/100;
        const totalDesc = kgHum + kgImp + kgCal;

        totalPeso += c.peso_salida;
        sumHum += c.humedad_salida*c.peso_salida;
        sumImp += c.impureza_salida*c.peso_salida;
        sumCal += c.calidad_salida*c.peso_salida;

        let claseDesc = (totalDesc > 100) ? "descAlto" : "";
        let claseEstado = c.estado === "Aplicado"? "aplicado":"borrador";

        tabla += `<tr class="${claseEstado}">
<td>${c.id}</td><td>${c.camion}</td><td>${c.chofer}</td><td>${c.entidad||''}</td>
<td>${c.peso_salida}</td><td>${c.peso_llegada}</td><td>${difPeso.toFixed(2)}</td>
<td>${c.humedad_salida}</td><td>${c.humedad_llegada}</td><td>${kgHum.toFixed(2)}</td>
<td>${c.impureza_salida}</td><td>${c.impureza_llegada}</td><td>${kgImp.toFixed(2)}</td>
<td>${c.calidad_salida}</td><td>${c.calidad_llegada}</td><td>${kgCal.toFixed(2)}</td>
<td class="${claseDesc}">${totalDesc.toFixed(2)}</td><td>${c.estado}</td>
</tr>`;
    });

    const promHum = totalPeso? (sumHum/totalPeso).toFixed(2):0;
    const promImp = totalPeso? (sumImp/totalPeso).toFixed(2):0;
    const promCal = totalPeso? (sumCal/totalPeso).toFixed(2):0;

    document.getElementById('resumen').innerHTML = `
<p>Peso total de salida: ${totalPeso.toFixed(2)} kg</p>
<p>Promedio Humedad: ${promHum}%</p>
<p>Promedio Impureza: ${promImp}%</p>
<p>Promedio Calidad: ${promCal}%</p>
`;

    document.getElementById('tablaRelatorio').innerHTML = tabla;
}

function cerrarRelatorio() { document.getElementById('relatorio').style.display = 'none'; }

// Imprimir relatorio limpio
function imprimirRelatorio() {
    const resumen = document.getElementById('resumen').innerHTML;
    const tabla = document.getElementById('tablaRelatorio').outerHTML;

    const ventana = window.open('', '', 'width=1200,height=800');
    ventana.document.write('<html><head><title>Relatorio Diario</title>');
    ventana.document.write('<style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #000;padding:5px;text-align:center;} h2,h3{margin:0;}</style>');
    ventana.document.write('</head><body>');
    ventana.document.write('<h2>Relatorio Diario</h2>');
    ventana.document.write(resumen);
    ventana.document.write(tabla);
    ventana.document.write('</body></html>');
    ventana.document.close();
    ventana.print();
}

mostrarTabla();
</script>

</body>
</html>
