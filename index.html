<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Cargas de Granos</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #334155;
            --text-dark: #0f172a;
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: var(--background);
            color: var(--text);
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        h2,
        h3 {
            color: var(--text-dark);
            margin-top: 0;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.1);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-outline {
            background: white;
            border-color: var(--border);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }

        .btn-icon-only {
            padding: 8px;
            background: transparent;
            color: #64748b;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-icon-only:hover {
            background: #f1f5f9;
            color: var(--primary);
        }

        .btn-icon-only.delete:hover {
            background: #fef2f2;
            color: var(--danger);
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Card/Table */
        .card {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            text-align: left;
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            color: #64748b;
            font-weight: 500;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Status Badge */
        .badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-borrador {
            background: #fff7ed;
            color: #c2410c;
        }

        .badge-aplicado {
            background: #ecfdf5;
            color: #047857;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Form */
        .form-section {
            margin-bottom: 24px;
        }

        .form-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
        }

        input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.875rem;
            outline: none;
            transition: 0.2s;
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Summary Stats */
        .stats-grid {
            display: grid;
            gap: 12px;
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 16px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
        }

        .stat-row.total {
            font-weight: 600;
            color: var(--text-dark);
            border-top: 1px solid #e2e8f0;
            padding-top: 8px;
            margin-top: 4px;
            font-size: 1rem;
        }

        /* Relatorio Print */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .no-print {
                display: none;
            }

            .card {
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header class="no-print">
            <h1>
                <svg class="icon" style="color:var(--primary)" viewBox="0 0 24 24">
                    <path
                        d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" />
                    <path d="M18 14h-8" />
                    <path d="M15 18h-5" />
                    <path d="M10 6h8v4h-8V6Z" />
                </svg>
                Silo Manager
            </h1>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-outline" onclick="window.logout()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    Salir
                </button>
                <button class="btn btn-outline" onclick="window.location.href='desechos.html'">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Pesaje Desechos
                </button>
                <button class="btn btn-outline" onclick="abrirRelatorio()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Relatorio
                </button>
                <button class="btn btn-primary" onclick="nuevo()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Nueva Carga
                </button>
            </div>
        </header>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Camión</th>
                        <th>Chofer</th>
                        <th>Entidad</th>
                        <th>Peso Neto</th>
                        <th>Estado</th>
                        <th class="no-print" style="text-align:right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaCargas">
                    <!-- Data loaded via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- EDITOR MODAL -->
    <div id="editorModal" class="modal-overlay no-print">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:24px;">
                <h2>Gestión de Carga</h2>
                <button class="btn-icon-only" onclick="cerrarEditor()"><svg class="icon" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>

            <div class="form-section">
                <h3 class="form-title">Datos Generales</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr 2fr;">
                    <div class="field"><label>Camión</label><input id="camion" type="text" placeholder="Patente"></div>
                    <div class="field"><label>Chofer</label><input id="chofer" type="text"
                            placeholder="Apellido Nombre"></div>
                    <div class="field"><label>Entidad</label><input id="entidad" type="text" placeholder="Cliente">
                    </div>
                </div>
            </div>

            <div class="grid">
                <div class="form-section">
                    <h3 class="form-title"><svg class="icon" style="width:16px;height:16px" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                        </svg> Origen (Salida)</h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="field"><label>Kg Bruto</label><input id="pesoSalida" type="number"></div>
                        <div class="field"><label>Humedad %</label><input id="humSalida" type="number"></div>
                        <div class="field"><label>Impureza %</label><input id="impSalida" type="number"></div>
                        <div class="field"><label>Calidad %</label><input id="calSalida" type="number"></div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="form-title"><svg class="icon" style="width:16px;height:16px" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" />
                            <circle cx="12" cy="12" r="3" fill="currentColor" />
                        </svg> Destino (Llegada)</h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="field"><label>Kg Bruto</label><input id="pesoLlegada" type="number"
                                oninput="calcular()"></div>
                        <div class="field"><label>Humedad %</label><input id="humLlegada" type="number"
                                oninput="calcular()"></div>
                        <div class="field"><label>Impureza %</label><input id="impLlegada" type="number"
                                oninput="calcular()"></div>
                        <div class="field"><label>Calidad %</label><input id="calLlegada" type="number"
                                oninput="calcular()"></div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="form-title">Descuentos Manuales</h3>
                <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="field"><label>Hum. (%)</label><input id="descHum" type="number" oninput="calcular()">
                    </div>
                    <div class="field"><label>Imp. (%)</label><input id="descImp" type="number" oninput="calcular()">
                    </div>
                    <div class="field"><label>Cal. (%)</label><input id="descCal" type="number" oninput="calcular()">
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-row"><span>Diferencia Peso:</span> <span id="difPeso">0</span></div>
                <div class="stat-row"><span>Desc. Humedad:</span> <span id="kgHum">0</span></div>
                <div class="stat-row"><span>Desc. Impureza:</span> <span id="kgImp">0</span></div>
                <div class="stat-row"><span>Desc. Calidad:</span> <span id="kgCal">0</span></div>
                <div class="stat-row total"><span>Total Descuentos:</span> <span id="totalDesc">0</span></div>
            </div>

            <div style="margin-top:24px; display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn btn-outline" onclick="cerrarEditor()">Cancelar</button>
                <button class="btn btn-primary" onclick="guardar()">Guardar Carga</button>
            </div>
        </div>
    </div>

    <!-- RELATORIO MODAL -->
    <div id="relatorioModal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;" class="no-print">
                <h2>Relatorio Diario</h2>
                <button class="btn-icon-only"
                    onclick="document.getElementById('relatorioModal').classList.remove('active')"><svg class="icon"
                        viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>

            <div class="grid no-print" style="margin-bottom:24px; grid-template-columns: auto 1fr auto auto;">
                <input type="date" id="filtroFecha">
                <input type="text" id="filtroEntidad" placeholder="Filtrar por Entidad">
                <button class="btn btn-primary" onclick="renderRelatorio()">Aplicar</button>
                <button class="btn btn-outline" onclick="window.print()">Imprimir</button>
            </div>

            <div id="relatorioContent"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy }
            from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJJP8RKILKRByrt4Afi55VvSAzY75M7hE",
            authDomain: "datos-de-jose-para-silo.firebaseapp.com",
            projectId: "datos-de-jose-para-silo",
            storageBucket: "datos-de-jose-para-silo.firebasestorage.app",
            messagingSenderId: "410080189279",
            appId: "1:410080189279:web:8cd03360742dc86c9a34ea",
            measurementId: "G-5RDFFX8G86"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let colRef = null;
        let localCargas = [];
        let editId = null;

        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Initialize User Data
                colRef = collection(db, 'users', user.uid, 'cargas');

                // Real-time listener
                const q = query(colRef, orderBy('fecha', 'desc'));
                onSnapshot(q, (snapshot) => {
                    localCargas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderTable();
                });
            } else {
                // Redirect if not logged in
                window.location.href = 'login.html';
            }
        });

        window.logout = () => {
            signOut(auth).then(() => window.location.href = 'login.html');
        };

        window.nuevo = () => {
            editId = null;
            document.getElementById('editorModal').classList.add('active');
            clearForm();
            calcular();
        };

        window.cerrarEditor = () => {
            document.getElementById('editorModal').classList.remove('active');
        };

        function clearForm() {
            const ids = ['camion', 'chofer', 'entidad', 'pesoSalida', 'humSalida', 'impSalida', 'calSalida',
                'pesoLlegada', 'humLlegada', 'impLlegada', 'calLlegada', 'descHum', 'descImp', 'descCal'];
            ids.forEach(id => document.getElementById(id).value = '');
        }

        window.editar = (id) => {
            const c = localCargas.find(x => x.id === id);
            if (!c) return;
            editId = id;
            document.getElementById('editorModal').classList.add('active');

            document.getElementById('camion').value = c.camion;
            document.getElementById('chofer').value = c.chofer;
            document.getElementById('entidad').value = c.entidad;
            document.getElementById('pesoSalida').value = c.peso_salida;
            document.getElementById('humSalida').value = c.humedad_salida;
            document.getElementById('impSalida').value = c.impureza_salida;
            document.getElementById('calSalida').value = c.calidad_salida;
            document.getElementById('pesoLlegada').value = c.peso_llegada;
            document.getElementById('humLlegada').value = c.humedad_llegada;
            document.getElementById('impLlegada').value = c.impureza_llegada;
            document.getElementById('calLlegada').value = c.calidad_llegada;
            document.getElementById('descHum').value = c.desc_humedad;
            document.getElementById('descImp').value = c.desc_impureza;
            document.getElementById('descCal').value = c.desc_calidad;
            calcular();
        };

        window.guardar = async () => {
            if (!colRef) return;

            const data = {
                fecha: new Date().toISOString().slice(0, 10),
                camion: document.getElementById('camion').value,
                chofer: document.getElementById('chofer').value,
                entidad: document.getElementById('entidad').value,
                peso_salida: parseFloat(document.getElementById('pesoSalida').value) || 0,
                humedad_salida: parseFloat(document.getElementById('humSalida').value) || 0,
                impureza_salida: parseFloat(document.getElementById('impSalida').value) || 0,
                calidad_salida: parseFloat(document.getElementById('calSalida').value) || 0,
                peso_llegada: parseFloat(document.getElementById('pesoLlegada').value) || 0,
                humedad_llegada: parseFloat(document.getElementById('humLlegada').value) || 0,
                impureza_llegada: parseFloat(document.getElementById('impLlegada').value) || 0,
                calidad_llegada: parseFloat(document.getElementById('calLlegada').value) || 0,
                desc_humedad: parseFloat(document.getElementById('descHum').value) || 0,
                desc_impureza: parseFloat(document.getElementById('descImp').value) || 0,
                desc_calidad: parseFloat(document.getElementById('descCal').value) || 0,
                estado: editId ? (localCargas.find(x => x.id === editId).estado) : "Borrador"
            };

            // Don't overwrite state if editing, unless new
            if (editId) {
                await updateDoc(doc(db, 'users', currentUser.uid, 'cargas', editId), data);
            } else {
                await addDoc(colRef, data);
            }
            cerrarEditor();
        };

        window.eliminar = async (id) => {
            if (confirm('¿Eliminar esta carga?')) await deleteDoc(doc(db, 'users', currentUser.uid, 'cargas', id));
        };

        window.toggleEstado = async (id) => {
            const c = localCargas.find(x => x.id === id);
            const nuevo = c.estado === 'Borrador' ? 'Aplicado' : 'Borrador';
            await updateDoc(doc(db, 'users', currentUser.uid, 'cargas', id), { estado: nuevo });
        };

        window.calcular = () => {
            const pesoLlegada = parseFloat(document.getElementById('pesoLlegada').value) || 0;
            const descHum = parseFloat(document.getElementById('descHum').value) || 0;
            const descImp = parseFloat(document.getElementById('descImp').value) || 0;
            const descCal = parseFloat(document.getElementById('descCal').value) || 0;

            const kHum = pesoLlegada * descHum / 100;
            const kImp = pesoLlegada * descImp / 100;
            const kCal = pesoLlegada * descCal / 100;

            document.getElementById('difPeso').innerText = ((parseFloat(document.getElementById('pesoSalida').value) || 0) - pesoLlegada).toFixed(2);

            document.getElementById('kgHum').innerText = kHum.toFixed(2);
            document.getElementById('kgImp').innerText = kImp.toFixed(2);
            document.getElementById('kgCal').innerText = kCal.toFixed(2);
            document.getElementById('totalDesc').innerText = (kHum + kImp + kCal).toFixed(2);
        };

        function renderTable() {
            const tbody = document.getElementById('listaCargas');
            if (!tbody) return;
            tbody.innerHTML = localCargas.map(c => `
            <tr>
                <td>${c.fecha}</td>
                <td><strong>${c.camion}</strong></td>
                <td>${c.chofer}</td>
                <td>${c.entidad || '-'}</td>
                <td>${c.peso_llegada}<span style="font-size:0.75em;color:#94a3b8">kg</span></td>
                <td><span class="badge badge-${c.estado.toLowerCase()}">${c.estado}</span></td>
                <td style="text-align:right">
                    <button class="btn-icon-only" onclick="editar('${c.id}')"><svg class="icon" viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg></button>
                    <button class="btn-icon-only" onclick="toggleEstado('${c.id}')"><svg class="icon" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg></button>
                    <button class="btn-icon-only delete" onclick="eliminar('${c.id}')"><svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </td>
            </tr>
        `).join('');
        };

        window.abrirRelatorio = () => {
            document.getElementById('relatorioModal').classList.add('active');
            renderRelatorio();
        };

        window.renderRelatorio = () => {
            const fecha = document.getElementById('filtroFecha').value;
            const ent = document.getElementById('filtroEntidad').value.toLowerCase();

            const filtered = localCargas.filter(c => {
                return (!fecha || c.fecha === fecha) && (!ent || (c.entidad && c.entidad.toLowerCase().includes(ent)));
            });

            let totalPeso = 0, sumHum = 0, sumImp = 0;

            const rows = filtered.map(c => {
                totalPeso += c.peso_llegada || 0;
                sumHum += (c.humedad_llegada || 0) * (c.peso_llegada || 0);
                sumImp += (c.impureza_llegada || 0) * (c.peso_llegada || 0);
                const totalKgDesc = (c.peso_llegada || 0) * ((c.desc_humedad || 0) + (c.desc_impureza || 0) + (c.desc_calidad || 0)) / 100;

                return `<tr>
                <td>${c.camion}</td>
                <td>${c.chofer}</td>
                <td>${c.entidad}</td>
                <td>${c.peso_llegada}</td>
                <td>${c.humedad_llegada}%</td>
                <td>${c.impureza_llegada}%</td>
                <td>${totalKgDesc.toFixed(1)}</td>
            </tr>`;
            }).join('');

            const avgHum = totalPeso ? (sumHum / totalPeso).toFixed(2) : 0;
            const avgImp = totalPeso ? (sumImp / totalPeso).toFixed(2) : 0;

            document.getElementById('relatorioContent').innerHTML = `
            <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 24px;">
                <div class="stat-row" style="flex-direction:column; gap:4px;"><span style="color:#64748b">Peso Total</span><span style="font-size:1.5em; font-weight:600">${totalPeso.toLocaleString()} kg</span></div>
                <div class="stat-row" style="flex-direction:column; gap:4px;"><span style="color:#64748b">Prom. Humedad</span><span style="font-size:1.5em; font-weight:600">${avgHum}%</span></div>
                <div class="stat-row" style="flex-direction:column; gap:4px;"><span style="color:#64748b">Prom. Impureza</span><span style="font-size:1.5em; font-weight:600">${avgImp}%</span></div>
            </div>
            <table>
                <thead>
                    <tr><th>Camión</th><th>Chofer</th><th>Entidad</th><th>Peso Llegada</th><th>Hum</th><th>Imp</th><th>Kg Desc</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
        };

    </script>
</body>

</html>