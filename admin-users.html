<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --background: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #334155;
            --text-dark: #0f172a;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: var(--background);
            color: var(--text);
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        h2 {
            color: var(--text-dark);
            margin-top: 0;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.1);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-outline {
            background: white;
            border-color: var(--border);
            color: var(--text-dark);
        }

        .btn-outline:hover {
            border-color: #cbd5e1;
            background: #f1f5f9;
        }

        .btn-icon-only {
            padding: 8px;
            background: transparent;
            color: #64748b;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-icon-only:hover {
            background: #f1f5f9;
            color: var(--primary);
        }

        .btn-icon-only.delete:hover {
            background: #fef2f2;
            color: var(--danger);
        }

        .btn-icon-only.success:hover {
            background: #ecfdf5;
            color: var(--success);
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* Card/Table */
        .card {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            text-align: left;
            padding: 16px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            color: #64748b;
            font-weight: 500;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Badge */
        .badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }

        .badge-admin {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-uploader {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-active {
            background: #ecfdf5;
            color: #047857;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Form */
        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
        }

        input,
        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.875rem;
            outline: none;
            transition: 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            flex-direction: column;
            gap: 16px;
        }

        .loader-overlay.active {
            display: flex;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-msg {
            background: #fef2f2;
            color: var(--danger);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-bottom: 16px;
            display: none;
        }

        .success-msg {
            background: #ecfdf5;
            color: var(--success);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-bottom: 16px;
            display: none;
        }
    </style>
</head>

<body>

    <div id="loader" class="loader-overlay active">
        <div class="spinner"></div>
        <div id="loaderText" style="font-weight: 500; color: var(--text-dark)">Cargando...</div>
    </div>

    <div class="container">
        <header>
            <h1>
                <svg class="icon" style="color:var(--primary)" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Gestión de Usuarios
            </h1>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-outline" onclick="window.location.href='./app.html'">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Volver
                </button>
                <button class="btn btn-primary" onclick="abrirModalNuevo()">
                    <svg class="icon" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Registrar Usuario
                </button>
            </div>
        </header>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Nombre</th>
                        <th>Rol</th>
                        <th>Cargas</th>
                        <th>Desechos</th>
                        <th>Estado</th>
                        <th>Creado</th>
                        <th style="text-align:right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaUsuarios">
                    <!-- Data loaded via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- MODAL NUEVO/EDITAR USUARIO -->
    <div id="editorModal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:24px;">
                <h2 id="modalTitle">Registrar Usuario</h2>
                <button class="btn-icon-only" onclick="cerrarModal()"><svg class="icon" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg></button>
            </div>

            <div id="errorBox" class="error-msg"></div>
            <div id="successBox" class="success-msg"></div>

            <div class="field">
                <label>Email</label>
                <input id="userEmail" type="email" placeholder="usuario@ejemplo.com">
            </div>

            <div class="field">
                <label>Nombre Completo</label>
                <input id="userDisplayName" type="text" placeholder="Juan Pérez">
            </div>

            <div class="field">
                <label>Rol</label>
                <select id="userRole">
                    <option value="uploader">Cargar Datos</option>
                    <option value="admin">Admin (Control total)</option>
                </select>
            </div>

            <div class="field" id="passwordField">
                <label>Contraseña Temporal</label>
                <input id="userPassword" type="password" placeholder="Mínimo 6 caracteres">
                <small style="color: #64748b; font-size: 0.75rem;">El usuario deberá cambiarla en su primer
                    login</small>
            </div>

            <div style="margin-top:24px; display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn btn-outline" onclick="cerrarModal()">Cancelar</button>
                <button id="btnGuardar" class="btn btn-primary" onclick="guardarUsuario()">
                    <span id="btnGuardarText">Registrar Usuario</span>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, onSnapshot, query, orderBy, Timestamp, collectionGroup } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCJJP8RKILKRByrt4Afi55VvSAzY75M7hE",
            authDomain: "datos-de-jose-para-silo.firebaseapp.com",
            projectId: "datos-de-jose-para-silo",
            storageBucket: "datos-de-jose-para-silo.firebasestorage.app",
            messagingSenderId: "410080189279",
            appId: "1:410080189279:web:8cd03360742dc86c9a34ea",
            measurementId: "G-5RDFFX8G86"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Helpers
        const showLoader = (text = 'Cargando...') => {
            const t = document.getElementById('loaderText');
            if (t) t.textContent = text;
            document.getElementById('loader').classList.add('active');
        };
        const hideLoader = () => document.getElementById('loader').classList.remove('active');

        const showError = (msg) => {
            const box = document.getElementById('errorBox');
            box.innerText = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 5000);
        };

        const showSuccess = (msg) => {
            const box = document.getElementById('successBox');
            box.innerText = msg;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        };

        // State
        let currentUser = null;
        let currentUserRole = null;
        let editingUserId = null;
        let allUsersData = [];

        // Auth Listener - Verificar que sea admin
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Verificar si es admin
                const userDoc = await getDoc(doc(db, 'usersMetadata', user.uid));
                if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                    alert('Acceso denegado. Solo administradores pueden acceder a esta página.');
                    window.location.href = './app.html';
                    return;
                }
                currentUserRole = userDoc.data().role;
                await loadAllUsers();
            } else {
                window.location.href = './index.html';
            }
        });

        async function loadAllUsers() {
            showLoader('Cargando usuarios y estadísticas...');

            try {
                // Cargar metadata de usuarios
                const metadataSnapshot = await getDocs(collection(db, 'usersMetadata'));
                const metadataMap = {};
                metadataSnapshot.forEach(doc => {
                    metadataMap[doc.id] = { id: doc.id, ...doc.data() };
                });

                // Cargar todos los usuarios de la colección users (que tienen datos)
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const userIds = new Set();

                // Agregar usuarios con metadata
                Object.keys(metadataMap).forEach(uid => userIds.add(uid));

                // Agregar usuarios que tienen datos pero no metadata
                usersSnapshot.forEach(doc => userIds.add(doc.id));

                // Construir array de usuarios con estadísticas
                allUsersData = [];

                for (const uid of userIds) {
                    const metadata = metadataMap[uid];

                    // Contar cargas y desechos
                    let cargasCount = 0;
                    let desechosCount = 0;

                    try {
                        const cargasSnapshot = await getDocs(collection(db, 'users', uid, 'cargas'));
                        cargasCount = cargasSnapshot.size;

                        const desechosSnapshot = await getDocs(collection(db, 'users', uid, 'desechos'));
                        desechosCount = desechosSnapshot.size;
                    } catch (e) {
                        // Usuario sin datos
                    }

                    allUsersData.push({
                        id: uid,
                        email: metadata?.email || 'Usuario sin metadata',
                        displayName: metadata?.displayName || '-',
                        role: metadata?.role || null,
                        isActive: metadata?.isActive !== false,
                        createdAt: metadata?.createdAt,
                        cargasCount,
                        desechosCount,
                        hasMetadata: !!metadata
                    });
                }

                // Ordenar por fecha de creación (más recientes primero)
                allUsersData.sort((a, b) => {
                    if (!a.createdAt) return 1;
                    if (!b.createdAt) return -1;
                    return b.createdAt.seconds - a.createdAt.seconds;
                });

                renderTable();
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Error al cargar usuarios');
            } finally {
                hideLoader();
            }
        }

        function renderTable() {
            const tbody = document.getElementById('listaUsuarios');
            if (!tbody) return;

            tbody.innerHTML = allUsersData.map(u => {
                const roleClass = u.role || 'uploader';
                const roleBadge = u.role
                    ? `<span class="badge badge-${roleClass}">${u.role}</span>`
                    : `<span class="badge" style="background:#f1f5f9;color:#64748b">Sin rol</span>`;

                const statusClass = u.isActive ? 'active' : 'inactive';
                const statusText = u.isActive ? 'Activo' : 'Inactivo';
                const createdDate = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString() : '-';

                // Botones según si tiene metadata o no
                const editBtn = u.hasMetadata
                    ? `<button class="btn-icon-only" onclick="editarUsuario('${u.id}')" title="Editar rol">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M12 20h9"/>
                            <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/>
                        </svg>
                    </button>`
                    : `<button class="btn-icon-only success" onclick="hacerAdmin('${u.id}', '${u.email}')" title="Hacer Admin">
                        <svg class="icon" viewBox="0 0 24 24">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </button>`;

                const toggleBtn = u.hasMetadata
                    ? `<button class="btn-icon-only ${u.isActive ? 'delete' : 'success'}" onclick="toggleEstado('${u.id}')" title="${u.isActive ? 'Desactivar' : 'Activar'}">
                        <svg class="icon" viewBox="0 0 24 24">
                            ${u.isActive ?
                        '<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>' :
                        '<polyline points="20 6 9 17 4 12"></polyline>'}
                        </svg>
                    </button>`
                    : '';

                return `
            <tr>
                <td><strong>${u.email}</strong></td>
                <td>${u.displayName}</td>
                <td>${roleBadge}</td>
                <td><span style="color:#64748b">${u.cargasCount}</span></td>
                <td><span style="color:#64748b">${u.desechosCount}</span></td>
                <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                <td>${createdDate}</td>
                <td style="text-align:right">
                    ${editBtn}
                    ${toggleBtn}
                </td>
            </tr>
        `}).join('');
        }

        window.hacerAdmin = async (uid, email) => {
            if (confirm(`¿Convertir a ${email} en administrador?\n\nEsto le dará control total del sistema.`)) {
                showLoader('Convirtiendo a admin...');
                try {
                    await setDoc(doc(db, 'usersMetadata', uid), {
                        email: email,
                        displayName: email.split('@')[0],
                        role: 'admin',
                        isActive: true,
                        createdAt: Timestamp.now(),
                        createdBy: currentUser.uid
                    });
                    alert('✅ Usuario convertido a admin. Recargando...');
                    await loadAllUsers();
                } catch (error) {
                    console.error(error);
                    alert('Error al convertir usuario');
                } finally {
                    hideLoader();
                }
            }
        };

        window.abrirModalNuevo = () => {
            editingUserId = null;
            document.getElementById('modalTitle').innerText = 'Registrar Usuario';
            document.getElementById('btnGuardarText').innerText = 'Registrar Usuario';
            document.getElementById('passwordField').style.display = 'block';
            clearForm();
            document.getElementById('editorModal').classList.add('active');
        };

        window.editarUsuario = (uid) => {
            const user = allUsersData.find(u => u.id === uid);
            if (!user || !user.hasMetadata) return;
            editingUserId = uid;
            document.getElementById('modalTitle').innerText = 'Editar Usuario';
            document.getElementById('btnGuardarText').innerText = 'Actualizar Usuario';
            document.getElementById('passwordField').style.display = 'none';

            document.getElementById('userEmail').value = user.email;
            document.getElementById('userEmail').disabled = true;
            document.getElementById('userDisplayName').value = user.displayName || '';
            document.getElementById('userRole').value = user.role || 'uploader';

            document.getElementById('editorModal').classList.add('active');
        };

        window.cerrarModal = () => {
            document.getElementById('editorModal').classList.remove('active');
            document.getElementById('userEmail').disabled = false;
            clearForm();
        };

        function clearForm() {
            document.getElementById('userEmail').value = '';
            document.getElementById('userDisplayName').value = '';
            document.getElementById('userRole').value = 'uploader';
            document.getElementById('userPassword').value = '';
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('successBox').style.display = 'none';
        }

        window.guardarUsuario = async () => {
            const email = document.getElementById('userEmail').value.trim();
            const displayName = document.getElementById('userDisplayName').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;

            if (!email || !displayName || !role) {
                showError('Por favor completa todos los campos');
                return;
            }

            if (!editingUserId && (!password || password.length < 6)) {
                showError('La contraseña debe tener al menos 6 caracteres');
                return;
            }

            const btn = document.getElementById('btnGuardar');
            btn.disabled = true;
            showLoader(editingUserId ? 'Actualizando...' : 'Registrando usuario...');

            try {
                if (editingUserId) {
                    // Actualizar usuario existente
                    await updateDoc(doc(db, 'usersMetadata', editingUserId), {
                        displayName,
                        role
                    });
                    showSuccess('Usuario actualizado correctamente');
                    setTimeout(async () => {
                        cerrarModal();
                        await loadAllUsers();
                    }, 1500);
                } else {
                    // Crear nuevo usuario
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const newUser = userCredential.user;

                    // Guardar metadata
                    await setDoc(doc(db, 'usersMetadata', newUser.uid), {
                        email,
                        displayName,
                        role,
                        isActive: true,
                        createdAt: Timestamp.now(),
                        createdBy: currentUser.uid
                    });

                    showSuccess('Usuario registrado correctamente');
                    setTimeout(async () => {
                        cerrarModal();
                        await loadAllUsers();
                    }, 1500);
                }
            } catch (error) {
                console.error(error);
                let msg = 'Error al guardar usuario';
                if (error.code === 'auth/email-already-in-use') msg = 'Este email ya está registrado';
                if (error.code === 'auth/invalid-email') msg = 'Email inválido';
                if (error.code === 'auth/weak-password') msg = 'Contraseña muy débil';
                showError(msg);
            } finally {
                hideLoader();
                btn.disabled = false;
            }
        };

        window.toggleEstado = async (uid) => {
            const user = allUsersData.find(u => u.id === uid);
            if (!user) return;

            const nuevoEstado = !user.isActive;
            const accion = nuevoEstado ? 'activar' : 'desactivar';

            if (confirm(`¿Estás seguro de ${accion} a ${user.email}?`)) {
                showLoader('Actualizando...');
                try {
                    await updateDoc(doc(db, 'usersMetadata', uid), {
                        isActive: nuevoEstado
                    });
                    await loadAllUsers();
                } catch (error) {
                    console.error(error);
                    alert('Error al actualizar estado');
                } finally {
                    hideLoader();
                }
            }
        };
    </script>
</body>

</html>